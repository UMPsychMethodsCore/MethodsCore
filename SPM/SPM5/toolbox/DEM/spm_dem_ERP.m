function [R] = spm_DEM_ERP(varargin)
% simulated electrophysiological response based on conditional estimates
% FORMAT [R] = spm_DEM_ERP(qU,qU,...)
% qU - conditional estimates of states
% R  - summed response over peri-stimulus time
%
% These simulated response assume that LFPs are generated by superficial
% pyramidal cells that correspond to units encoding prediction error.
% Peristimulus time histograms (PSTH) assume that states (U) are encoded
% using a non-negative firing rate that is proportional to exp(U), using
% an opponent system
%__________________________________________________________________________


% loop over ERPs
%--------------------------------------------------------------------------
clf
N     = length(varargin);
for i = 1:N
    
    qU = varargin{i};
    U  = qU.z;
    
    % loop over ERPs
    %----------------------------------------------------------------------
    n  = length(U);
    for  j = 1:n
        
        % ERPs
        %------------------------------------------------------------------
        subplot(n,2,2*(j - 1) + 1)
        plot(mean(U{j},1),'Color',[1 1 1]*(1 - 1/i))
        title(sprintf('LFPs: level %i',j))
        axis square
        grid on
        hold on
        
        % PSTH
        %------------------------------------------------------------------
        subplot(n,2,2*j)
        PSTH    = mean(exp(U{j}) + exp(-U{j}),1)/2;
        R{j}(i) = mean(PSTH);
        plot(PSTH,'Color',[1 1 1]*(1 - 1/i),'LineWidth',3)
        title(sprintf('PSTH: level %i',j))
        axis square
        hold on
        
    end
    
end
